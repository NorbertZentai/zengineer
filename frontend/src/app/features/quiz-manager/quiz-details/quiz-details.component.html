<!-- Scroll to top button -->
<button class="scroll-to-top-btn" *ngIf="showScrollTop" (click)="scrollToTop()" title="Ugr√°s a tetej√©re">
  <mat-icon>vertical_align_top</mat-icon>
</button>
<div class="quiz-details-container">
  <!-- Header -->
  <div class="quiz-header">
    <button class="back-btn" (click)="goBack()">
      <mat-icon>arrow_back</mat-icon>
      <span>Vissza a kv√≠zekhez</span>
    </button>
    
    <div class="quiz-info" *ngIf="quiz">
      <div class="quiz-title-section">
        <div class="quiz-color-indicator" [style.background-color]="quiz.color"></div>
        <div class="quiz-content">
          <div class="quiz-title-row">
            <h1 class="quiz-title">{{ quiz.name }}</h1>
            <div class="quiz-header-actions">
              <button class="test-btn" 
                      (click)="openTestConfig()" 
                      [disabled]="cards.length === 0"
                      [title]="'TEST.START_TEST' | translate">
                <mat-icon>play_arrow</mat-icon>
                <span>{{ 'TEST.START_TEST' | translate }}</span>
              </button>
              
              <button *ngIf="isOwner" class="expand-btn" 
                      (click)="toggleSettings()" 
                      [class.expanded]="showSettings"
                      title="Be√°ll√≠t√°sok megjelen√≠t√©se/elrejt√©se">
                <mat-icon>expand_more</mat-icon>
              </button>
              <mat-icon class="visibility-icon" [title]="quiz.visibility === 'public' ? 'Nyilv√°nos kv√≠z' : 'Priv√°t kv√≠z'">
                {{ quiz.visibility === 'public' ? 'lock_open' : 'lock' }}
              </mat-icon>
            </div>
          </div>
          <p class="quiz-description" *ngIf="quiz.description">{{ quiz.description }}</p>
        </div>
      </div>

      <!-- Be√°ll√≠t√°sok szekci√≥ - a quiz-info blokkon bel√ºl -->
      <div class="settings-panel" *ngIf="showSettings && isOwner" [@slideDown]>
        <div class="settings-content">
          <form class="settings-form" (ngSubmit)="saveSettings()">
            <div class="form-row">
              <div class="form-group">
                <label for="quizName">Kv√≠z neve</label>
                <input type="text" id="quizName" [(ngModel)]="editForm.name" name="quizName" placeholder="Add meg a kv√≠z nev√©t" required>
              </div>
              <div class="form-group">
                <label for="difficulty">Neh√©zs√©gi szint</label>
                <select id="difficulty" [(ngModel)]="editForm.difficulty_level" name="difficulty">
                  <option value="1">üü¢ Kezd≈ë</option>
                  <option value="2">üîµ Alapfok</option>
                  <option value="3">üü° K√∂zepes</option>
                  <option value="4">üü† Halad√≥</option>
                  <option value="5">üî¥ Expert</option>
                </select>
              </div>
            </div>
            
            <div class="form-group full-width">
              <label for="quizDescription">Le√≠r√°s</label>
              <textarea id="quizDescription" [(ngModel)]="editForm.description" name="quizDescription" placeholder="√çrd le mire vonatkozik ez a kv√≠z..."></textarea>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label for="visibility">L√°that√≥s√°g</label>
                <select id="visibility" [(ngModel)]="editForm.visibility" name="visibility">
                  <option value="private">üîí Priv√°t</option>
                  <option value="public">üåç Nyilv√°nos</option>
                </select>
              </div>
              <div class="form-group">
                <label for="language">Nyelv</label>
                <select id="language" [(ngModel)]="editForm.language" name="language">
                  <option value="hu">üá≠üá∫ Magyar</option>
                  <option value="en">üá¨üáß English</option>
                  <option value="de">üá©üá™ Deutsch</option>
                  <option value="fr">üá´üá∑ Fran√ßais</option>
                </select>
              </div>
            </div>

            <div class="form-group color-selection">
              <label>T√©ma sz√≠n</label>
              <div class="color-palette">
                <div class="color-option" 
                     *ngFor="let color of colorPalette" 
                     [style.background-color]="color.value"
                     [class.selected]="editForm.color === color.value"
                     (click)="selectColor(color.value)"
                     [title]="color.name">
                </div>
              </div>
            </div>
            
            <div class="form-group full-width">
              <label for="tags">C√≠mk√©k (vessz≈ëvel elv√°lasztva)</label>
              <input type="text" id="tags" [(ngModel)]="tagsString" name="tags" placeholder="pl: matematika, algebra, egyenletek">
            </div>
            
            <div class="form-actions">
              <button type="button" class="btn btn-cancel" (click)="cancelEdit()">
                <mat-icon>close</mat-icon>
                <span>M√©gse</span>
              </button>
              <button type="submit" class="btn btn-save" [disabled]="!editForm.name.trim()">
                <mat-icon>save</mat-icon>
                <span>Ment√©s</span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="spinner"></div>
    <p>Bet√∂lt√©s...</p>
  </div>

  <!-- Error -->
  <div *ngIf="error" class="error-container">
    <mat-icon>error</mat-icon>
    <p>
      <span *ngIf="error && error.includes('JSON.parse error:')">
        <b>R√©szletes hiba:</b><br>
        {{ error }}
      </span>
      <span *ngIf="!error || !error.includes('JSON.parse error:')">
        {{ error }}
      </span>
    </p>
  </div>

  <!-- Quiz Stats -->
  <div class="quiz-stats" *ngIf="quiz && !isLoading">
    <div class="stat-item">
      <mat-icon>quiz</mat-icon>
      <span class="stat-number">{{ cards.length }}</span>
      <span class="stat-label">k√°rtya</span>
    </div>
    <div class="stat-item">
      <mat-icon>schedule</mat-icon>
      <span class="stat-label">L√©trehozva: {{ formatDate(quiz.created_at!) }}</span>
    </div>
  </div>

  <!-- Cards Section -->
  <div class="cards-section" *ngIf="!isLoading">
    <div class="section-header">
      <h2>K√°rty√°k ({{ cards.length }})</h2>
    </div>

    <!-- Quick Card Creator - Always visible at top -->
    <div class="quick-card-creator" *ngIf="isOwner">
      <div class="creator-header">
        <mat-icon>quiz</mat-icon>
        <span>√öj k√°rtya hozz√°ad√°sa</span>
      </div>
      
      <!-- Rich Text Editor for Question -->
      <div class="question-editor-container">
        <div class="editor-toolbar">
          <div class="toolbar-group">
            <button type="button" 
                    class="toolbar-btn" 
                    [class.active]="isFormatActive('bold')"
                    (click)="formatText('bold')"
                    title="F√©lk√∂v√©r">
              <mat-icon>format_bold</mat-icon>
            </button>
            <button type="button" 
                    class="toolbar-btn" 
                    [class.active]="isFormatActive('italic')"
                    (click)="formatText('italic')"
                    title="D≈ëlt">
              <mat-icon>format_italic</mat-icon>
            </button>
            <button type="button" 
                    class="toolbar-btn" 
                    [class.active]="isFormatActive('underline')"
                    (click)="formatText('underline')"
                    title="Al√°h√∫zott">
              <mat-icon>format_underlined</mat-icon>
            </button>
          </div>
          
          <div class="toolbar-group">
            <button type="button" 
                    class="toolbar-btn" 
                    (click)="formatText('insertUnorderedList')"
                    title="Felsorol√°s">
              <mat-icon>format_list_bulleted</mat-icon>
            </button>
            <button type="button" 
                    class="toolbar-btn" 
                    (click)="formatText('insertOrderedList')"
                    title="Sz√°mozott lista">
              <mat-icon>format_list_numbered</mat-icon>
            </button>
          </div>
          
          <div class="toolbar-group">
            <button type="button" 
                    class="toolbar-btn" 
                    (click)="insertImage()"
                    title="K√©p besz√∫r√°sa">
              <mat-icon>image</mat-icon>
            </button>
            <button type="button" 
                    class="toolbar-btn" 
                    (click)="insertLink()"
                    title="Link besz√∫r√°sa">
              <mat-icon>link</mat-icon>
            </button>
          </div>
        </div>
        
        <div class="question-editor" 
             #questionEditor
             contenteditable="true"
             (input)="onQuestionChange($event)"
             (blur)="onQuestionBlur()"
             [attr.data-placeholder]="'K√©rd√©s vagy fogalom...'">
        </div>
        
        <!-- Hidden file input for images -->
        <input type="file" 
               #imageInput
               accept="image/*"
               (change)="onImageSelect($event)"
               style="display: none;">
      </div>

      <!-- Dynamic answers list -->
      <div class="answers-container">
        <div class="answer-row" *ngFor="let answer of newCard.answers; let i = index; let isLast = last; trackBy: trackByIndex">
          <button type="button" 
                  class="answer-type-btn" 
                  [class.correct]="answer.isCorrect"
                  [class.incorrect]="!answer.isCorrect"
                  (click)="toggleAnswerType(i)"
                  title="{{ answer.isCorrect ? 'Helyes v√°lasz' : 'Rossz v√°lasz' }}">
            <mat-icon>{{ answer.isCorrect ? 'check' : 'close' }}</mat-icon>
          </button>
          <input type="text" 
                 [(ngModel)]="answer.text" 
                 placeholder="V√°lasz..."
                 class="answer-input"
                 (keydown.enter)="handleAnswerEnter(i, $event)">
          <button type="button" 
                  *ngIf="newCard.answers.length > 1"
                  class="remove-answer-btn" 
                  (click)="removeAnswer(i)"
                  title="V√°lasz t√∂rl√©se">
            <mat-icon>remove</mat-icon>
          </button>
          <button type="button" 
                  *ngIf="isLast"
                  class="add-answer-btn" 
                  (click)="addNewAnswer()"
                  title="√öj v√°lasz hozz√°ad√°sa">
            <mat-icon>add</mat-icon>
          </button>
        </div>
      </div>

      <!-- Save button -->
      <div class="creator-actions">
        <button class="save-card-btn" 
                (click)="saveQuickCard()" 
                [disabled]="!isQuickCardValid()"
                title="K√°rtya ment√©se">
          <mat-icon>save</mat-icon>
          <span>Ment√©s</span>
        </button>
      </div>
    </div>

    <!-- Cards Grid -->
    <div class="cards-grid" *ngIf="cards.length > 0">
      <div class="card-item" 
           *ngFor="let card of cards; trackBy: trackByCardId" 
           [class.flipped]="card.isFlipped"
           (click)="flipCard(card)">
        
        <!-- Card Front -->
        <div class="card-face card-front">
          <!-- Card performance indicator -->
          <div class="card-performance" *ngIf="getCardPerformance(card.id!)">
            <div class="performance-badge" [class]="getCardPerformanceClass(card.id!)">
              <mat-icon>{{ getCardPerformanceIcon(card.id!) }}</mat-icon>
              <span>{{ getCardSuccessRate(card.id!) }}%</span>
            </div>
            <div class="performance-stats">
              <span class="attempts">{{ getCardPerformance(card.id!)?.total_attempts || 0 }} {{ 'TEST.PERFORMANCE.ATTEMPTS' | translate }}</span>
            </div>
          </div>
          
          <div class="card-content">
            <div class="card-question">
              {{ card.question }}
            </div>
            <div class="card-flip-hint">
              <mat-icon>touch_app</mat-icon>
              <span>Kattints a v√°laszok√©rt</span>
            </div>
          </div>
        </div>

        <!-- Card Back -->
        <div class="card-face card-back">    
          <div class="card-content">
            <div class="card-answers">
              <!-- Single answer for flashcard -->
              <div *ngIf="card.card_type === 'flashcard'" class="flashcard-answer">
                {{ card.answer }}
              </div>
              
              <!-- Multiple answers for multiple choice -->
              <div *ngIf="card.card_type === 'multiple_choice'" class="multiple-choice-answers">
                <ng-container *ngIf="(getParsedAnswers(card)?.correct || []).length > 0">
                  <div class="correct-answers">
                    <div class="answer-item correct" *ngFor="let answer of getParsedAnswers(card)?.correct || []">
                      <mat-icon>check</mat-icon>
                      <span>{{ answer }}</span>
                    </div>
                  </div>
                </ng-container>
                <ng-container *ngIf="(getParsedAnswers(card)?.incorrect || []).length > 0">
                  <div class="incorrect-answers">
                    <div class="answer-item incorrect" *ngFor="let answer of getParsedAnswers(card)?.incorrect || []">
                      <mat-icon>close</mat-icon>
                      <span>{{ answer }}</span>
                    </div>
                  </div>
                </ng-container>
              </div>
            </div>
            
            <div class="card-hint" *ngIf="card.hint">
              <mat-icon>lightbulb</mat-icon>
              <span>{{ card.hint }}</span>
            </div>
          </div>
          <!-- Card actions jobb fels≈ë sarok -->
          <div class="card-actions" (click)="$event.stopPropagation()" *ngIf="isOwner">
            <button class="action-btn edit" (click)="editCard(card)" title="Szerkeszt√©s">
              <mat-icon>edit</mat-icon>
            </button>
            <button class="action-btn delete" (click)="deleteCard(card.id!)" title="T√∂rl√©s">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div class="empty-cards" *ngIf="cards.length === 0 && !isLoading">
      <div class="empty-illustration">
        <mat-icon>quiz</mat-icon>
      </div>
      <h3>M√©g nincsenek k√°rty√°k</h3>
      <p>Hozd l√©tre az els≈ë k√°rty√°t a fenti ≈±rlappal!</p>
    </div>
  </div>
</div>

<!-- Test Configuration Modal -->
<app-test-config-modal 
  *ngIf="showTestConfig"
  [quizId]="quiz?.id || ''"
  [quizName]="quiz?.name || ''"
  [totalCards]="cards.length"
  (close)="closeTestConfig()"
  (startTest)="startTest($event)">
</app-test-config-modal>
