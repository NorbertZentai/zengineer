<!-- Scroll to top button -->
<button class="scroll-to-top-btn" *ngIf="showScrollTop" (click)="scrollToTop()" title="Ugr√°s a tetej√©re">
  <mat-icon>vertical_align_top</mat-icon>
</button>
<div class="quiz-details-container">
  <!-- Header -->
  <div class="quiz-header">
    <button class="back-btn" (click)="goBack()">
      <mat-icon>arrow_back</mat-icon>
      <span>{{ 'QUIZ_MANAGER.LABELS.BACK_TO_QUIZZES' | translate }}</span>
    </button>
    
    <div class="quiz-info" *ngIf="quiz">
      <div class="quiz-title-section">
        <div class="quiz-color-indicator" [style.background-color]="quiz.color"></div>
        <div class="quiz-content">
          <div class="quiz-title-row">
            <h1 class="quiz-title">{{ quiz.name }}</h1>
            <div class="quiz-header-actions">
              <button class="test-btn" [matMenuTriggerFor]="testStartMenu" [disabled]="cards.length === 0" [title]="'TEST.START_TEST' | translate">
                <mat-icon>play_arrow</mat-icon>
                <span>{{ 'TEST.START_TEST' | translate }}</span>
              </button>
              <mat-menu #testStartMenu="matMenu" panelClass="test-start-menu">
                <button mat-menu-item (click)="startLearningMode()">
                  <mat-icon>school</mat-icon>
                  <span>{{ 'TEST.MENU.LEARNING' | translate }}</span>
                </button>
                <button mat-menu-item (click)="startEasyMode()">
                  <mat-icon>sentiment_satisfied</mat-icon>
                  <span>{{ 'DIFFICULTY_LEVEL.EASY' | translate }}</span>
                </button>
                <button mat-menu-item (click)="startMediumMode()">
                  <mat-icon>sentiment_neutral</mat-icon>
                  <span>{{ 'DIFFICULTY_LEVEL.MEDIUM' | translate }}</span>
                </button>
                <button mat-menu-item (click)="startHardMode()">
                  <mat-icon>sentiment_very_dissatisfied</mat-icon>
                  <span>{{ 'DIFFICULTY_LEVEL.HARD' | translate }}</span>
                </button>
                <button mat-menu-item (click)="startAiTestFromDetails()">
                  <mat-icon>smart_toy</mat-icon>
                  <span>{{ 'QUIZ_MANAGER.ACTIONS.AI_TEST' | translate }}</span>
                </button>
                <button mat-menu-item (click)="openTestConfig()">
                  <mat-icon>settings</mat-icon>
                  <span>{{ 'TEST.MENU.CUSTOM' | translate }}</span>
                </button>
              </mat-menu>
              
              <button *ngIf="isOwner" class="expand-btn" 
                      (click)="toggleSettings()" 
                      [class.expanded]="showSettings"
                      title="Be√°ll√≠t√°sok megjelen√≠t√©se/elrejt√©se">
                <mat-icon>expand_more</mat-icon>
              </button>
              <mat-icon class="visibility-icon" [title]="quiz.visibility === 'public' ? 'Nyilv√°nos kv√≠z' : 'Priv√°t kv√≠z'">
                {{ quiz.visibility === 'public' ? 'lock_open' : 'lock' }}
              </mat-icon>
            </div>
          </div>
          <p class="quiz-description" *ngIf="quiz.description">{{ quiz.description }}</p>
        </div>
      </div>

      <!-- Be√°ll√≠t√°sok szekci√≥ - a quiz-info blokkon bel√ºl -->
      <div class="settings-panel" *ngIf="showSettings && isOwner" [@slideDown]>
        <div class="settings-content">
          <form class="settings-form" (ngSubmit)="saveSettings()">
            <div class="form-row">
              <div class="form-group">
                <label for="quizName">{{ 'QUIZ_MANAGER.LABELS.QUIZ_NAME' | translate }}</label>
                <input type="text" id="quizName" [(ngModel)]="editForm.name" name="quizName" [placeholder]="'QUIZ_MANAGER.LABELS.QUIZ_NAME' | translate" required>
              </div>
              <div class="form-group">
                <label for="difficulty">{{ 'QUIZ_MANAGER.LABELS.DIFFICULTY_LEVEL' | translate }}</label>
                <select id="difficulty" [(ngModel)]="editForm.difficulty_level" name="difficulty">
                  <option value="1">üü¢ {{ 'DIFFICULTY_PRESET.BEGINNER' | translate }}</option>
                  <option value="2">üîµ {{ 'DIFFICULTY_PRESET.BASIC' | translate }}</option>
                  <option value="3">üü° {{ 'DIFFICULTY_LEVEL.MEDIUM' | translate }}</option>
                  <option value="4">üü† {{ 'DIFFICULTY_PRESET.ADVANCED' | translate }}</option>
                  <option value="5">üî¥ {{ 'DIFFICULTY_PRESET.EXPERT' | translate }}</option>
                </select>
              </div>
            </div>
            
            <div class="form-group full-width">
              <label for="quizDescription">{{ 'QUIZ_MANAGER.LABELS.DESCRIPTION' | translate }}</label>
              <textarea id="quizDescription" [(ngModel)]="editForm.description" name="quizDescription" [placeholder]="'QUIZ_MANAGER.LABELS.DESCRIPTION_PLACEHOLDER' | translate"></textarea>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label for="visibility">{{ 'QUIZ_MANAGER.LABELS.VISIBILITY' | translate }}</label>
                <select id="visibility" [(ngModel)]="editForm.visibility" name="visibility">
                  <option value="private">üîí {{ 'COMMON.PRIVATE' | translate }}</option>
                  <option value="public">üåç {{ 'COMMON.PUBLIC' | translate }}</option>
                </select>
              </div>
              <div class="form-group">
                <label for="language">{{ 'NAV.LANGUAGE' | translate }}</label>
                <select id="language" [(ngModel)]="editForm.language" name="language">
                  <option value="hu">üá≠üá∫ Magyar</option>
                  <option value="en">üá¨üáß English</option>
                  <option value="de">üá©üá™ Deutsch</option>
                  <option value="fr">üá´üá∑ Fran√ßais</option>
                </select>
              </div>
            </div>

            <div class="form-group color-selection">
              <label>{{ 'QUIZ_MANAGER.LABELS.THEME_COLOR' | translate }}</label>
              <div class="color-palette">
                <div class="color-option" 
                     *ngFor="let color of colorPalette" 
                     [style.background-color]="color.value"
                     [class.selected]="editForm.color === color.value"
                     (click)="selectColor(color.value)"
                     [title]="color.name">
                </div>
              </div>
            </div>
            
            <div class="form-group full-width">
              <label for="tags">{{ 'QUIZ_MANAGER.LABELS.TAGS' | translate }}</label>
              <input type="text" id="tags" [(ngModel)]="tagsString" name="tags" [placeholder]="'QUIZ_MANAGER.LABELS.TAGS_PLACEHOLDER' | translate">
            </div>
            
            <div class="form-actions">
              <button type="button" class="btn btn-cancel" (click)="cancelEdit()">
                <mat-icon>close</mat-icon>
                <span>{{ 'COMMON.CANCEL' | translate }}</span>
              </button>
              <button type="submit" class="btn btn-save" [disabled]="!editForm.name.trim()">
                <mat-icon>save</mat-icon>
                <span>{{ 'COMMON.SAVE' | translate }}</span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="spinner"></div>
    <p>{{ 'COMMON.LOADING' | translate }}</p>
  </div>

  <!-- Error -->
  <div *ngIf="error" class="error-container">
    <mat-icon>error</mat-icon>
    <p>
      <span *ngIf="error && error.includes('JSON.parse error:')">
        <b>R√©szletes hiba:</b><br>
        {{ error }}
      </span>
      <span *ngIf="!error || !error.includes('JSON.parse error:')">
        {{ error }}
      </span>
    </p>
  </div>

  <!-- Quiz Stats -->
  <div class="quiz-stats" *ngIf="quiz && !isLoading">
    <div class="stat-item">
      <mat-icon>quiz</mat-icon>
      <span class="stat-number">{{ cards.length }}</span>
  <span class="stat-label">{{ 'QUIZ_MANAGER.STATS.CARDS' | translate }}</span>
    </div>
    <div class="stat-item">
      <mat-icon>schedule</mat-icon>
  <span class="stat-label">{{ 'QUIZ_MANAGER.LABELS.CREATED_AT' | translate }}: {{ formatDate(quiz.created_at!) }}</span>
    </div>
    <!-- AI controls: single button opens difficulty menu -->
    <div class="ai-controls" *ngIf="isOwner">
      <button class="test-btn ai-btn" [matMenuTriggerFor]="aiDifficultyMenu" [title]="'QUIZ_MANAGER.ACTIONS.AI_CARDS' | translate">
        <mat-icon>bolt</mat-icon>
        <span>{{ 'QUIZ_MANAGER.ACTIONS.AI_CARDS' | translate }}</span>
      </button>
      <mat-menu #aiDifficultyMenu="matMenu">
        <button mat-menu-item (click)="generateAiCardsForThisQuiz('easy')">
          <mat-icon>sentiment_satisfied</mat-icon>
          <span>{{ 'DIFFICULTY_LEVEL.EASY' | translate }}</span>
        </button>
        <button mat-menu-item (click)="generateAiCardsForThisQuiz('medium')">
          <mat-icon>sentiment_neutral</mat-icon>
          <span>{{ 'DIFFICULTY_LEVEL.MEDIUM' | translate }}</span>
        </button>
        <button mat-menu-item (click)="generateAiCardsForThisQuiz('hard')">
          <mat-icon>sentiment_very_dissatisfied</mat-icon>
          <span>{{ 'DIFFICULTY_LEVEL.HARD' | translate }}</span>
        </button>
        <button mat-menu-item (click)="openAiCardConfig()" type="button">
          <mat-icon>settings</mat-icon>
          <span>{{ 'TEST.MENU.CUSTOM' | translate }}</span>
        </button>
      </mat-menu>
    </div>
  </div>

  <!-- Cards Section -->
  <div class="cards-section" *ngIf="!isLoading">
    <div class="section-header">
      <h2>{{ 'QUIZ_MANAGER.LABELS.CARDS_HEADER' | translate }} ({{ cards.length }})</h2>
    </div>

    <!-- Quick Card Creator - Always visible at top -->
    <div class="quick-card-creator" *ngIf="isOwner">
      <div class="creator-header">
        <mat-icon>{{ isEditingCard ? 'edit' : 'quiz' }}</mat-icon>
        <span>{{ isEditingCard ? ('QUIZ_MANAGER.LABELS.EDIT_CARD' | translate) : ('QUIZ_MANAGER.LABELS.ADD_NEW_CARD' | translate) }}</span>
      </div>
      
      <!-- Rich Text Editor for Question -->
      <div class="question-editor-container">
        <div class="editor-toolbar">
          <div class="toolbar-group">
            <button type="button" 
                    class="toolbar-btn" 
                    [class.active]="isFormatActive('bold')"
                    (click)="formatText('bold')"
                    title="F√©lk√∂v√©r">
              <mat-icon>format_bold</mat-icon>
            </button>
            <button type="button" 
                    class="toolbar-btn" 
                    [class.active]="isFormatActive('italic')"
                    (click)="formatText('italic')"
                    title="D≈ëlt">
              <mat-icon>format_italic</mat-icon>
            </button>
            <button type="button" 
                    class="toolbar-btn" 
                    [class.active]="isFormatActive('underline')"
                    (click)="formatText('underline')"
                    title="Al√°h√∫zott">
              <mat-icon>format_underlined</mat-icon>
            </button>
          </div>
          
          <div class="toolbar-group">
            <button type="button" 
                    class="toolbar-btn" 
                    (click)="formatText('insertUnorderedList')"
                    title="Felsorol√°s">
              <mat-icon>format_list_bulleted</mat-icon>
            </button>
            <button type="button" 
                    class="toolbar-btn" 
                    (click)="formatText('insertOrderedList')"
                    title="Sz√°mozott lista">
              <mat-icon>format_list_numbered</mat-icon>
            </button>
          </div>
          
          <div class="toolbar-group">
            <button type="button" 
                    class="toolbar-btn" 
                    (click)="insertImage()"
                    title="K√©p besz√∫r√°sa">
              <mat-icon>image</mat-icon>
            </button>
            <button type="button" 
                    class="toolbar-btn" 
                    (click)="insertLink()"
                    title="Link besz√∫r√°sa">
              <mat-icon>link</mat-icon>
            </button>
          </div>
        </div>
        
  <div class="question-editor" 
             #questionEditor
             contenteditable="true"
             (input)="onQuestionChange($event)"
             (focus)="onQuestionFocus()"
             (blur)="onQuestionBlur()"
       [attr.data-placeholder]="'QUIZ_MANAGER.PLACEHOLDERS.QUESTION_OR_TERM' | translate">
        </div>
        
        <!-- Hidden file input for images -->
        <input type="file" 
               #imageInput
               accept="image/*"
               (change)="onImageSelect($event)"
               style="display: none;">
      </div>

      <!-- Dynamic answers list -->
      <div class="answers-container">
        <div class="answer-row" *ngFor="let answer of newCard.answers; let i = index; let isLast = last; trackBy: trackByIndex">
          <button type="button" 
                  class="answer-type-btn" 
                  [class.correct]="answer.isCorrect"
                  [class.incorrect]="!answer.isCorrect"
                  (click)="toggleAnswerType(i)"
                  title="{{ answer.isCorrect ? 'Helyes v√°lasz' : 'Rossz v√°lasz' }}">
            <mat-icon>{{ answer.isCorrect ? 'check' : 'close' }}</mat-icon>
          </button>
     <input type="text" 
                 [(ngModel)]="answer.text" 
       [placeholder]="'QUIZ_MANAGER.PLACEHOLDERS.ANSWER' | translate"
                 class="answer-input"
                 (keydown.enter)="handleAnswerEnter(i, $event)">
          <button type="button" 
                  *ngIf="newCard.answers.length > 1"
                  class="remove-answer-btn" 
                  (click)="removeAnswer(i)"
                  title="V√°lasz t√∂rl√©se">
            <mat-icon>remove</mat-icon>
          </button>
          <button type="button" 
                  *ngIf="isLast"
                  class="add-answer-btn" 
                  (click)="addNewAnswer()"
                  title="√öj v√°lasz hozz√°ad√°sa">
            <mat-icon>add</mat-icon>
          </button>
        </div>
      </div>

      <!-- Hint field -->
      <div class="hint-container">
        <input type="text" 
               [(ngModel)]="newCard.hint" 
               placeholder="{{ 'QUIZ_MANAGER.PLACEHOLDERS.HINT' | translate }}"
               class="hint-input">
      </div>

      <!-- Save button -->
      <div class="creator-actions">
        <button class="save-card-btn" 
                (click)="saveQuickCard()" 
                [disabled]="!isQuickCardValid()"
                [title]="isEditingCard ? 'K√°rtya friss√≠t√©se' : 'K√°rtya ment√©se'">
          <mat-icon>{{ isEditingCard ? 'update' : 'save' }}</mat-icon>
          <span>{{ isEditingCard ? 'Friss√≠t√©s' : 'Ment√©s' }}</span>
        </button>
        <button class="cancel-btn" 
                *ngIf="isEditingCard"
                (click)="cancelEdit()"
                title="Szerkeszt√©s megszak√≠t√°sa">
          <mat-icon>close</mat-icon>
          <span>M√©gse</span>
        </button>
      </div>
    </div>

    <!-- Cards Grid -->
    <div class="cards-grid" *ngIf="cards.length > 0">
      <div class="card-wrapper" 
           #cardItem
           *ngFor="let card of cards; trackBy: trackByCardId">
        
        <!-- Performance indicator - floating badge -->
        <div class="performance-badge" [class]="'performance-' + getCardPerformanceClass(card.id!)">
          <mat-icon>{{ getCardPerformanceIcon(card.id!) }}</mat-icon>
          <span class="performance-text">{{ getCardPerformanceText(card.id!) }}</span>
        </div>
        
        <div class="card-item" 
             [class.flipped]="card.isFlipped"
             (click)="flipCard(card)">
        
          <!-- Card Front -->
          <div class="card-face card-front">
            
            <div class="card-content">
              <div class="card-question">
                {{ card.question }}
              </div>
              <div class="card-flip-hint">
                <mat-icon>touch_app</mat-icon>
                <span>{{ 'TEST.EXECUTION.CLICK_FOR_ANSWER' | translate }}</span>
              </div>
            </div>
            
            <!-- Card actions jobb fels≈ë sarok -->
            <div class="card-actions" (click)="$event.stopPropagation()" *ngIf="isOwner">
              <button class="action-btn ai-analysis" 
                      (click)="getAiAnalysis(card)" 
                      [disabled]="isAnalysisLoading(card.id!)"
                      [class.has-result]="hasAnalysisResult(card.id!)"
                      title="AI Elemz√©s">
                <mat-icon>{{ isAnalysisLoading(card.id!) ? 'hourglass_empty' : 'smart_toy' }}</mat-icon>
              </button>
              <button class="action-btn edit" (click)="editCard(card)" title="Szerkeszt√©s">
                <mat-icon>edit</mat-icon>
              </button>
              <button class="action-btn delete" (click)="deleteCard(card.id!)" title="T√∂rl√©s">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>

        <!-- Card Back -->
        <div class="card-face card-back">    
          <div class="card-content">
            <div class="card-answers">
              <!-- Single answer for flashcard -->
              <div *ngIf="card.card_type === 'flashcard'" class="flashcard-answer">
                {{ getCardAnswer(card) }}
              </div>
              
              <!-- Multiple answers for multiple choice -->
              <div *ngIf="card.card_type === 'multiple_choice'" class="multiple-choice-answers">
                <ng-container *ngIf="(getParsedAnswers(card)?.correct || []).length > 0">
                  <div class="correct-answers">
                    <div class="answer-item correct" *ngFor="let answer of getParsedAnswers(card)?.correct || []">
                      <mat-icon>check</mat-icon>
                      <span>{{ answer }}</span>
                    </div>
                  </div>
                </ng-container>
                <ng-container *ngIf="(getParsedAnswers(card)?.incorrect || []).length > 0">
                  <div class="incorrect-answers">
                    <div class="answer-item incorrect" *ngFor="let answer of getParsedAnswers(card)?.incorrect || []">
                      <mat-icon>close</mat-icon>
                      <span>{{ answer }}</span>
                    </div>
                  </div>
                </ng-container>
              </div>
            </div>
            
            <div class="card-hint" *ngIf="getCardHint(card)">
              <mat-icon>lightbulb</mat-icon>
              <span>{{ getCardHint(card) }}</span>
            </div>
          </div>
          <!-- Card actions jobb fels≈ë sarok -->
          <div class="card-actions" (click)="$event.stopPropagation()" *ngIf="isOwner">
            <button class="action-btn ai-analysis" 
                    (click)="getAiAnalysis(card)" 
                    [disabled]="isAnalysisLoading(card.id!)"
                    [class.has-result]="hasAnalysisResult(card.id!)"
                    title="AI Elemz√©s">
              <mat-icon>{{ isAnalysisLoading(card.id!) ? 'hourglass_empty' : 'smart_toy' }}</mat-icon>
            </button>
            <button class="action-btn edit" (click)="editCard(card)" title="Szerkeszt√©s">
              <mat-icon>edit</mat-icon>
            </button>
            <button class="action-btn delete" (click)="deleteCard(card.id!)" title="T√∂rl√©s">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </div>
        
        <!-- AI Analysis Result -->
        <div class="ai-analysis-result" *ngIf="hasAnalysisResult(card.id!)">
          <div class="analysis-header">
            <mat-icon>smart_toy</mat-icon>
            <span>AI Elemz√©s</span>
          </div>
          <div class="analysis-content">
            <div class="analysis-score">
              Min≈ës√©gi pontsz√°m: {{ getAnalysisResult(card.id!)?.qualityScore || 'N/A' }}/10
            </div>
            <div class="analysis-suggestions" *ngIf="getAnalysisResult(card.id!)?.suggestions?.length > 0">
              <h4>Javaslatok:</h4>
              <ul>
                <li *ngFor="let suggestion of getAnalysisResult(card.id!)?.suggestions">{{ suggestion }}</li>
              </ul>
            </div>
            <div class="analysis-improvements" *ngIf="getAnalysisResult(card.id!)?.improvements?.length > 0">
              <h4>Fejleszt√©si lehet≈ës√©gek:</h4>
              <ul>
                <li *ngFor="let improvement of getAnalysisResult(card.id!)?.improvements">{{ improvement }}</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div class="empty-cards" *ngIf="cards.length === 0 && !isLoading">
      <div class="empty-illustration">
        <mat-icon>quiz</mat-icon>
      </div>
      <h3>{{ 'QUIZ_MANAGER.CARDS_EMPTY.TITLE' | translate }}</h3>
      <p>{{ 'QUIZ_MANAGER.CARDS_EMPTY.SUBTITLE' | translate }}</p>
    </div>
  </div>
</div>

<!-- Test Configuration Modal -->
<app-test-config-modal 
  *ngIf="showTestConfig"
  [quizId]="quiz?.id || ''"
  [quizName]="quiz?.name || ''"
  [totalCards]="cards.length"
  (close)="closeTestConfig()"
  (startTest)="startTest($event)">
</app-test-config-modal>

<!-- AI Card Configuration Modal -->
<app-ai-card-config-modal 
  *ngIf="showAiCardConfig"
  [quizId]="quiz?.id || ''"
  [quizName]="quiz?.name || ''"
  [quizData]="quiz"
  (close)="closeAiCardConfig()"
  (generateCards)="generateCustomAiCards($event)">
</app-ai-card-config-modal>
