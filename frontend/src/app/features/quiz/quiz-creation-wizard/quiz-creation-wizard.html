<div class="wizard-container">
  <div class="wizard-header">
    <h2>
      <span class="auto-fix-icon"></span>
      Új Quiz Létrehozása
    </h2>
    <button class="close-btn" (click)="cancel()">
      <span class="close-icon"></span>
    </button>
  </div>

  <mat-stepper [selectedIndex]="currentStep()" orientation="horizontal" class="wizard-stepper">
    <!-- Step 1: Template Selection -->
    <mat-step [completed]="currentStep() > 0">
      <ng-template matStepLabel>Sablon kiválasztása</ng-template>
      <div class="step-content">
        <h3>Válassz egy sablont a kezdéshez</h3>
        <p>A sablonok alapbeállításokat és példa kártyákat tartalmaznak, amelyeket testreszabhatsz.</p>
        
        <div class="templates-grid">
          <mat-card 
            *ngFor="let template of templates()" 
            class="template-card"
            [class.selected]="quizData().template?.id === template.id"
            (click)="selectTemplate(template)">
            <mat-card-content>
              <div class="template-icon">
                <mat-icon>{{ template.icon }}</mat-icon>
              </div>
              <h4>{{ template.name }}</h4>
              <p>{{ template.description }}</p>
              <div class="template-info">
                <span class="sample-count">
                  {{ template.sampleCards.length }} példa kártya
                </span>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </div>
    </mat-step>

    <!-- Step 2: Basic Information -->
    <mat-step [completed]="currentStep() > 1">
      <ng-template matStepLabel>Alapadatok</ng-template>
      <div class="step-content">
        <form [formGroup]="basicInfoForm" class="basic-info-form">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Quiz neve</mat-label>
            <input matInput formControlName="name" placeholder="Add meg a quiz nevét">
            <mat-error *ngIf="basicInfoForm.get('name')?.hasError('required')">
              A quiz neve kötelező
            </mat-error>
            <mat-error *ngIf="basicInfoForm.get('name')?.hasError('minlength')">
              A név legalább 2 karakter hosszú legyen
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Leírás (opcionális)</mat-label>
            <textarea 
              matInput 
              formControlName="description" 
              rows="3"
              placeholder="Rövid leírás a quiz tartalmáról">
            </textarea>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Kategória</mat-label>
            <mat-select formControlName="category">
              <mat-option *ngFor="let category of categories" [value]="category">
                {{ category }}
              </mat-option>
            </mat-select>
            <mat-error *ngIf="basicInfoForm.get('category')?.hasError('required')">
              Válassz egy kategóriát
            </mat-error>
          </mat-form-field>

          <div class="tags-section">
            <h4>Címkék</h4>
            <mat-form-field appearance="outline" class="tag-input">
              <mat-label>Új címke</mat-label>
              <input 
                matInput 
                #tagInput
                placeholder="Írj egy címkét és nyomj Enter-t"
                (keydown.enter)="addTagToBasic(tagInput.value); tagInput.value = ''">
            </mat-form-field>
            
            <div class="selected-tags" *ngIf="quizData().basic.tags.length > 0">
              <mat-chip 
                *ngFor="let tag of quizData().basic.tags"
                class="selected-tag">
                {{ tag }}
                <button matChipRemove (click)="removeTagFromBasic(tag)">
                  <mat-icon>cancel</mat-icon>
                </button>
              </mat-chip>
            </div>
          </div>
        </form>

        <div class="step-actions">
          <button mat-button (click)="previousStep()">Vissza</button>
          <button 
            mat-raised-button 
            color="primary" 
            (click)="nextStep()"
            [disabled]="!basicInfoForm.valid">
            Tovább
          </button>
        </div>
      </div>
    </mat-step>

    <!-- Step 3: Settings -->
    <mat-step [completed]="currentStep() > 2">
      <ng-template matStepLabel>Beállítások</ng-template>
      <div class="step-content">
        <form [formGroup]="settingsForm" class="settings-form">
          <h3>Tanulási beállítások</h3>
          
          <mat-form-field appearance="outline">
            <mat-label>Alapértelmezett nehézség</mat-label>
            <mat-select formControlName="difficulty">
              <mat-option value="easy">Könnyű</mat-option>
              <mat-option value="medium">Közepes</mat-option>
              <mat-option value="hard">Nehéz</mat-option>
            </mat-select>
          </mat-form-field>

          <div class="checkbox-group">
            <mat-checkbox formControlName="autoReview">
              Automatikus ismétlés
              <small>A rendszer automatikusan ütemezi az ismétléseket</small>
            </mat-checkbox>

            <mat-checkbox formControlName="shuffleCards">
              Kártyák keverése
              <small>A kártyák véletlenszerű sorrendben jelennek meg</small>
            </mat-checkbox>
          </div>

          <div class="slider-group">
            <label>Napi cél (kártyák száma): {{ settingsForm.get('dailyGoal')?.value }}</label>
            <mat-slider 
              min="5" 
              max="100" 
              step="5" 
              showTickMarks
              discrete>
              <input matSliderThumb formControlName="dailyGoal">
            </mat-slider>
          </div>

          <mat-form-field appearance="outline">
            <mat-label>Időkorlát (perc, opcionális)</mat-label>
            <input 
              matInput 
              type="number" 
              formControlName="timeLimit"
              placeholder="Hagyj üresen korlátlan időért">
          </mat-form-field>
        </form>

        <div class="step-actions">
          <button mat-button (click)="previousStep()">Vissza</button>
          <button 
            mat-raised-button 
            color="primary" 
            (click)="nextStep()">
            Tovább
          </button>
        </div>
      </div>
    </mat-step>

    <!-- Step 4: Cards -->
    <mat-step [completed]="currentStep() > 3">
      <ng-template matStepLabel>Kártyák</ng-template>
      <div class="step-content">
        <div class="cards-section">
          <h3>Kártyák hozzáadása</h3>
          
          <!-- Existing Cards -->
          <div class="existing-cards" *ngIf="quizData().cards.length > 0">
            <h4>Jelenlegi kártyák ({{ quizData().cards.length }})</h4>
            <div class="cards-list">
              <div 
                *ngFor="let card of quizData().cards; let i = index" 
                class="card-preview">
                <div class="card-content">
                  <div class="card-front">{{ card.front }}</div>
                  <div class="card-back">{{ card.back }}</div>
                  <div class="card-meta">
                    <span 
                      class="difficulty-badge"
                      [style.background-color]="getDifficultyColor(card.difficulty!)">
                      {{ getDifficultyLabel(card.difficulty!) }}
                    </span>
                    <div class="card-tags" *ngIf="card.tags && card.tags.length > 0">
                      <mat-chip *ngFor="let tag of card.tags" class="tag-chip">
                        {{ tag }}
                      </mat-chip>
                    </div>
                  </div>
                </div>
                <button 
                  mat-icon-button 
                  color="warn"
                  (click)="removeCard(i)"
                  matTooltip="Kártya törlése">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>
          </div>

          <!-- Add New Card -->
          <div class="add-card-section">
            <h4>Új kártya hozzáadása</h4>
            <div class="new-card-form">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Kérdés / Előlap</mat-label>
                <textarea 
                  matInput 
                  [value]="newCardFront()"
                  (input)="newCardFront.set($any($event.target).value)"
                  rows="2"
                  placeholder="Add meg a kérdést">
                </textarea>
              </mat-form-field>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Válasz / Hátlap</mat-label>
                <textarea 
                  matInput 
                  [value]="newCardBack()"
                  (input)="newCardBack.set($any($event.target).value)"
                  rows="2"
                  placeholder="Add meg a választ">
                </textarea>
              </mat-form-field>

              <div class="card-options">
                <mat-form-field appearance="outline">
                  <mat-label>Nehézség</mat-label>
                  <mat-select 
                    [value]="newCardDifficulty()"
                    (selectionChange)="newCardDifficulty.set($event.value)">
                    <mat-option value="easy">Könnyű</mat-option>
                    <mat-option value="medium">Közepes</mat-option>
                    <mat-option value="hard">Nehéz</mat-option>
                  </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline" class="tag-input">
                  <mat-label>Címke hozzáadása</mat-label>
                  <input 
                    matInput 
                    #newTagInput
                    placeholder="Írj egy címkét és nyomj Enter-t"
                    (keydown.enter)="addTagToNewCard(newTagInput.value); newTagInput.value = ''">
                </mat-form-field>
              </div>

              <div class="new-card-tags" *ngIf="newCardTags().length > 0">
                <mat-chip 
                  *ngFor="let tag of newCardTags()"
                  class="selected-tag">
                  {{ tag }}
                  <button matChipRemove (click)="removeTagFromNewCard(tag)">
                    <mat-icon>cancel</mat-icon>
                  </button>
                </mat-chip>
              </div>

              <button 
                mat-raised-button 
                color="accent"
                (click)="addCard()"
                [disabled]="!newCardFront().trim() || !newCardBack().trim()">
                <mat-icon>add</mat-icon>
                Kártya hozzáadása
              </button>
            </div>
          </div>
        </div>

        <div class="step-actions">
          <button mat-button (click)="previousStep()">Vissza</button>
          <button 
            mat-raised-button 
            color="primary" 
            (click)="createQuiz()"
            [disabled]="quizData().cards.length === 0 || isLoading()">
            <mat-icon>check</mat-icon>
            {{ isLoading() ? 'Létrehozás...' : 'Quiz létrehozása' }}
          </button>
        </div>
      </div>
    </mat-step>
  </mat-stepper>

  <div class="loading-overlay" *ngIf="isLoading()">
    <mat-progress-bar mode="indeterminate"></mat-progress-bar>
  </div>
</div>
